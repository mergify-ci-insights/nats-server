name: MQTT External Tests
on: [pull_request]

permissions:
  contents: read

jobs:
  test:
    env:
      GOPATH: /home/runner/work/nats-server
      GO111MODULE: "on"
    runs-on: ${{ vars.GHA_WORKER_SMALL || 'ubuntu-latest' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: src/github.com/nats-io/nats-server

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: src/github.com/nats-io/nats-server/go.sum

      - name: Set up testing tools and environment
        shell: bash --noprofile --norc -eo pipefail {0}
        id: setup
        run: |
          wget https://github.com/hivemq/mqtt-cli/releases/download/v4.20.0/mqtt-cli-4.20.0.deb
          sudo apt install ./mqtt-cli-4.20.0.deb
          go install github.com/ConnectEverything/mqtt-test@v0.1.0
          go install github.com/jstemmer/go-junit-report/v2@latest

      - name: Run tests (3 times to detect flappers)
        shell: bash --noprofile --norc -eo pipefail {0}
        run: |
          cd src/github.com/nats-io/nats-server
          go test -v --count=3 --run='TestXMQTT' ./server 2>&1 | go-junit-report -set-exit-code > junit-mqtt-flappers.xml

      - name: Upload flapper test results to CI Insights
        if: success() || failure()
        uses: mergifyio/gha-mergify-ci@v6
        with:
          token: ${{ secrets.MERGIFY_TOKEN }}
          job_name: test (flappers)
          report_path: junit-mqtt-flappers.xml

      - name: Run tests with --race
        shell: bash --noprofile --norc -eo pipefail {0}
        run: |
          cd src/github.com/nats-io/nats-server
          go test -v --race --failfast --run='TestXMQTT' ./server 2>&1 | go-junit-report -set-exit-code > junit-mqtt-race.xml

      - name: Upload race test results to CI Insights
        if: success() || failure()
        uses: mergifyio/gha-mergify-ci@v6
        with:
          token: ${{ secrets.MERGIFY_TOKEN }}
          job_name: test (race)
          report_path: junit-mqtt-race.xml
